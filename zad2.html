<html>
	<canvas id="game" width="800" height="600">
		<script>
			/* todo: 
				- improve clearing of bullets
				- impl destroying balls*/
			var c = document.getElementById("game");
            var ctx = c.getContext("2d");
			var player = {
				x: 380,
				y: 580
			};
			var targets = []
			
            ctx.beginPath();
            ctx.rect(player.x, player.y, 40, 20);
			ctx.stroke();
			
			ctx.fillStyle = 'blue';
            ctx.fill();
			
			var spawned = 0;
			var score = 0;
			function spawnCircle() {
                if((spawned - score) <= 5) {  
					var canv = document.getElementById("game");
					var ctx = canv.getContext("2d");

					ctx.beginPath();
					var r = getRandom(30, 75);
					var x = getRandom(r, 800 - r);
					var y = getRandom(r, 400 - r);
					ctx.arc(x, y, r, 0, 2 * Math.PI);
					ctx.stroke();
					
					targets.push({x: x, y: y, r: r});
					spawned += 1;
				}	
            }
			
			document.addEventListener('keydown', getKey);
			
			function getKey(key) {
				var acceptableMoves = ["ArrowLeft", "ArrowRight"]
				
				if(acceptableMoves.includes(key.code)) {
					move(key.code);
				} else if(key.code === "Space") {
					shoot();
				}
			}
			
			function move(direction) {
				var reverse = direction === "ArrowLeft" ? -1 : 1;
				if((reverse < 0 && player.x > 0) || (reverse > 0 && player.x < 760)) {
					var canv = document.getElementById("game");
					var ctx = canv.getContext("2d");
					ctx.clearRect(player.x - 1, player.y - 1, 42, 21);
					
					player.x = player.x + 10 * reverse;
					
					ctx.beginPath();
					ctx.rect(player.x, player.y, 40, 20);
					ctx.stroke();
					ctx.fillStyle = 'blue';
					ctx.fill();
				}
			}
			
			function shoot() {
				var canv = document.getElementById("game");
				var ctx = canv.getContext("2d");
				
				ctx.beginPath();
				ctx.arc(player.x + 20, player.y - 10, 5, 0, 2 * Math.PI);
				ctx.stroke();
				
				setTimeout(function f() { bulletFly(player.x + 20, player.y - 10); }, 100 );
			}
			
			function bulletFly(x, y) {
				if(y > 10) {
					var canv = document.getElementById("game");
					var ctx = canv.getContext("2d");
					
					ctx.clearRect(x - 6, y - 6, 12, 12);
					
					var collision = findCollision({x: x, y: y})

					if(collision === null) {
						ctx.beginPath();
						ctx.arc(x, y - 10, 5, 0, 2 * Math.PI);
						ctx.stroke();
						
						setTimeout(function f() { bulletFly(x, y - 10); }, 100 );
					} else {
						/* it only removes from targets array, it also need to clear arc */
						targets = targets.filter( function(t) { return t != collision; } );
						console.log(targets)
					}
				} else if(y >= 10) {
					var canv = document.getElementById("game");
					var ctx = canv.getContext("2d");
					ctx.clearRect(x - 6, y - 6, 12, 12);
				}
			}
			
			function getRandom(min, max) {
				return Math.random() * (max - min) + min;
			}

			function findCollision(position) {
				for(const target of targets) {
					/* it is checking with the center of the bullet*/
					if(withinSquareBuildOnCircle(position, target)) {
							var distance = distanceFromMiddleOfCircle(position, target);
							if(distance <= target.r) return target;
						}
				}
				return null;
			}

			function withinSquareBuildOnCircle(position, circle) {
				return position.y >= circle.y - circle.r && position.y <= circle.y + circle.r &&
						position.x <= circle.x + circle.r && position.x >= circle.x - circle.r;
			}

			function distanceFromMiddleOfCircle(position, circle) {
				return Math.sqrt(Math.pow(circle.x - position.x, 2) + Math.pow(circle.y - position.y, 2));
			}
            setInterval(spawnCircle, 1000);
		</script>
	</canvas>
</html>